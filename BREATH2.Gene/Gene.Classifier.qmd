---
title: "Gene.Classifier"
format: html
toc: true
---



# Import Data

```{r}
#| warning: false

library(dplyr)
library(magrittr)

data_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/data"
results_dir <- "C:/Users/User/Documents/UCSF/BREATH2.Gene/results"


metadata_df_ALL <- read.csv(file.path(data_dir, "sample_metadata.csv"), stringsAsFactors=F)

JCI_expanded_metadata <- read.csv(file.path(data_dir, "fixed_metadata_10242025.csv"))

vap_soma_normalized <- read.csv(file.path(data_dir, "vap_soma_normalized.csv"))





#------------------------------------------------------------------------------#




# Include only the 150 patients with both transcriptomic and proteomic data
patients_vector <- intersect(vap_soma_normalized$patient_id, 
                             JCI_expanded_metadata$SubjectID)

Prot.Data <- vap_soma_normalized[vap_soma_normalized$patient_id %in% patients_vector, ]
Meta.Data <- JCI_expanded_metadata[JCI_expanded_metadata$SubjectID %in% patients_vector, ]


# Ensures rows of Meta.Data match those of Prot.Data
Meta.Data <- Meta.Data[match(Prot.Data$patient_id, Meta.Data$SubjectID), ]

# Produces data frame with patients, age_in_years, sex, and LRTI_Adjudication
patient_info_ALL <- data.frame(
  sample_name = Meta.Data$sanitized_name,
  patient_id = Prot.Data$patient_id,
  sex = Meta.Data$sex,
  age_in_years = Meta.Data$age_in_years,
  LRTI_adjudication = Meta.Data$LRTI_adjudication,
  stringsAsFactors = FALSE
)

# Restrict metadata_df to same 105 patients used in patient_info
metadata_df <- metadata_df_ALL %>%
  filter(sample_name %in% patient_info_ALL$sample_name) %>%
  filter(LRTI_adjudication %in% c("Definite", "No Evidence")) %>%
  left_join(patient_info_ALL %>% select(sample_name, patient_id),
    by = "sample_name") %>%
  relocate(patient_id, .after = sample_name)


nrow(metadata_df)  # should be 105

# Write csv
write.csv(metadata_df, file.path(data_dir, "metadata_df.csv"), row.names = FALSE)




#------------------------------------------------------------------------------#



# Define parameters
Definite <- table(patient_info_ALL$LRTI_adjudication)["Definite"]
No_Evidence <- table(patient_info_ALL$LRTI_adjudication)["No Evidence"]
npatients <- Definite + No_Evidence
nfolds <- 5
ntrees <- 10000

# Store parameters as data frame
Parameters <- data.frame(c(npatients, Definite, No_Evidence, nfolds, ntrees))
row.names(Parameters) = c("Patients", "Definite", "No Evidence", "Folds", "RF Trees")
colnames(Parameters) = "Count"

write.csv(Parameters, file.path(data_dir, "parameters.csv"), row.names = TRUE)

print(Parameters)




#------------------------------------------------------------------------------#
```




# Fold Assignment


```{r}
#| warning: false

library(dplyr)
library(magrittr)

# Set seed
set.seed(8634782)

metadata_df <- read.csv(file.path(data_dir, "metadata_df.csv"), stringsAsFactors=F)



#------------------------------------------------------------------------------#



# Generate folds for 5-fold cross-validation; ensure each fold has >=6 No Evidence samples
folds_ok <- FALSE

# Adds fold column to patient_info to create patient_info_with_folds
while (!folds_ok) {
  metadata_df_with_folds <- metadata_df %>%
    group_by(LRTI_adjudication) %>%
    mutate(fold = sample(rep(1:nfolds, length.out = n()))) %>%
    ungroup()
  
# Check if each fold has at least 6 "No Evidence" samples because ⌊33 / 5⌋ = 6
  counts <- table(metadata_df_with_folds$fold, 
                  metadata_df_with_folds$LRTI_adjudication)
  if (all(counts[, "No Evidence"] >= 6)) {
    folds_ok <- TRUE
  }
}



#------------------------------------------------------------------------------#



# Patient info with fold assignment
write.csv(metadata_df_with_folds, 
          file.path(data_dir, "metadata_df_with_folds.csv"), row.names = FALSE)

print(counts)
```







# Filter / transform host counts

```{r}
#| warning: false

library(dplyr)
library(magrittr)
library(DESeq2)

# Read metadata_df_with_folds table
metadata_df_with_folds <- read.csv(file.path(data_dir, "metadata_df_with_folds.csv"), stringsAsFactors = F) 
  
# Read host counts, omitting the first column (gene symbol)
host_counts <- read.csv(file.path(data_dir, "host_gene_counts.csv"), stringsAsFactors = F, row.names = 1)[,-1]

# Filter host counts to the samples used for CV
host_counts[, metadata_df_with_folds$sample_name] ->
  cv_host_counts



#------------------------------------------------------------------------------#




# Filter for genes with >10 counts in >20% of samples
keep <- rowSums(cv_host_counts > 10) > 0.2*ncol(cv_host_counts)
cv_host_counts <- cv_host_counts[keep, ]

# Apply variance stabilizing transform
dds <- DESeq2::DESeqDataSetFromMatrix(countData = cv_host_counts,
                                      colData = metadata_df_with_folds,
                                      design = ~1)
vsd <- DESeq2::varianceStabilizingTransformation(dds)
# Round transformed values to 2 decimal digits
vsd_mat <- SummarizedExperiment::assay(vsd) %>% 
  round(., digits=2)

# Save VST output
write.csv(vsd_mat, file.path(data_dir, "cv_vst.csv"))
```




# Run LASSO

```{r}
#| warning: false

library(dplyr)
library(magrittr)
library(glmnet)
library(tibble)

set.seed(8634782)


# Import data
metadata_df_with_folds <- read.csv(file.path(data_dir, "metadata_df_with_folds.csv"), stringsAsFactors = FALSE)
vsd_mat <- read.csv(file.path(data_dir, "cv_vst.csv"), row.names = 1)

# Vector mapping Ensembl IDs → gene symbols
read.csv(file.path(data_dir, "host_gene_counts.csv"), stringsAsFactors = FALSE) %>%
  {`names<-`(.$gene_symbol, .$X)} ->
  ensg2gene

# Prepare matrices
X <- t(as.matrix(vsd_mat))   # transpose so samples = rows, genes = columns
y <- metadata_df_with_folds$LRTI_adjudication == "Definite"




#-----------------------------------------------------------------------------#




# Function to extract nonzero coefficients with gene symbol mapping
lasso_coef_df <- function(mod) {
  coefs <- coef(mod, s = "lambda.1se")[, 1]
  coefs <- coefs[-1]  # remove intercept
  
  nonzero <- coefs[coefs != 0]
  
  # Ensure at least top 3 by absolute value if model is sparse
  if (length(nonzero) < 3) {
    abs_coefs <- abs(coefs)
    top3 <- sort(abs_coefs, decreasing = TRUE)[1:3]
    nonzero <- coefs[names(top3)]
  }
  
  data.frame(
    gene = names(nonzero),
    coef = as.numeric(nonzero),
    gene_symbol = ensg2gene[names(nonzero)],
    stringsAsFactors = FALSE
  )
}

# Function for a single outer CV fold
lasso_cv_outer_fold <- function(test_fold) {
  train <- metadata_df_with_folds$fold != test_fold
  foldid <- metadata_df_with_folds$fold[train]
  foldid <- as.integer(as.factor(foldid))
  
  mod <- glmnet::cv.glmnet(
    X[train, ], y[train],
    family = "binomial",
    foldid = foldid
  )
  
  preds <- predict(mod, X[!train, ], type = "response", s = "lambda.1se")[, 1] %>%
    data.frame(pred = .) %>%
    tibble::rownames_to_column("sample_name")
  
  nonzero <- lasso_coef_df(mod) %>%
    mutate(fold = test_fold)
  
  list(pred = preds, mod = mod, coef = nonzero)
}


# Run LASSO across all folds
lasso_results <- lapply(1:max(metadata_df_with_folds$fold), lasso_cv_outer_fold)

# Combine predictions and coefficients
lasso_preds <- lasso_results %>%
  lapply(function(x) x$pred) %>%
  bind_rows()

lasso_fold_coefs <- lasso_results %>%
  lapply(function(x) x$coef) %>%
  bind_rows()



#-----------------------------------------------------------------------------#




lasso_fold_coefs <- lasso_fold_coefs %>%
  mutate(
    coef = as.numeric(coef),
    gene = as.character(gene),
    fold = as.integer(fold)
  )

# Top 3 by absolute coefficient (overall)
lasso_fold_coefs_top3 <- lasso_fold_coefs %>%
  group_by(gene) %>%
  slice_max(order_by = abs(coef), n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(desc(abs(coef))) %>%
  head(3)

# Top 1 per fold
lasso_fold_coefs_top1_per_fold <- lasso_fold_coefs %>%
  group_by(fold) %>%
  slice_max(order_by = abs(coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Top 3 per fold
lasso_fold_coefs_top3_per_fold <- lasso_fold_coefs %>%
  group_by(fold) %>%
  slice_max(order_by = abs(coef), n = 3, with_ties = FALSE) %>%
  ungroup()



#-----------------------------------------------------------------------------#


write.csv(lasso_preds,
          file.path(results_dir, "lasso_preds.csv"),
          row.names = FALSE)

write.csv(lasso_fold_coefs,
          file.path(results_dir, "lasso_fold_coefs.csv"),
          row.names = FALSE)

write.csv(lasso_fold_coefs_top3,
          file.path(results_dir, "lasso_fold_coefs_top3.csv"),
          row.names = FALSE)

write.csv(lasso_fold_coefs_top1_per_fold,
          file.path(results_dir, "lasso_fold_coefs_top1_per_fold.csv"),
          row.names = FALSE)

write.csv(lasso_fold_coefs_top3_per_fold,
          file.path(results_dir, "lasso_fold_coefs_top3_per_fold.csv"),
          row.names = FALSE)



#-----------------------------------------------------------------------------#



print(table(lasso_fold_coefs$gene))
print(lasso_fold_coefs_top3)


```




# Random Forest

```{r}
#| warning: false

library(dplyr)
library(magrittr)
library(randomForest)
library(tibble)

set.seed(8634782)

# Import data
metadata_df_with_folds <- read.csv(file.path(data_dir, "metadata_df_with_folds.csv"), stringsAsFactors = FALSE)
vsd_mat <- read.csv(file.path(data_dir, "cv_vst.csv"), row.names = 1, check.names = FALSE)

# Use transposed version
vsd_mat_t <- t(as.matrix(vsd_mat))

# Convert patient_id to character
metadata_df_with_folds$patient_id <- as.character(metadata_df_with_folds$patient_id)

# Import selected proteins
lasso_fold_coefs <- read.csv(
  file.path(results_dir, "lasso_fold_coefs.csv"), 
  stringsAsFactors = FALSE)

lasso_fold_coefs_top1_per_fold <- read.csv(
  file.path(results_dir, "lasso_fold_coefs_top1_per_fold.csv"),
  stringsAsFactors = FALSE)

lasso_fold_coefs_top3_per_fold <- read.csv(
  file.path(results_dir, "lasso_fold_coefs_top3_per_fold.csv"),
  stringsAsFactors = FALSE)


# Choose which LASSO feature set to use for RF (uncomment ONE line)

# Option 1: All nonzero proteins across folds
selected_lasso_coefs <- lasso_fold_coefs

# Option 2: Top 3 proteins across all folds (Also uncomment the line with ➡️ below)
#selected_lasso_coefs <- lasso_fold_coefs_top3

# Option 3: Top 1 protein per fold
#selected_lasso_coefs <- lasso_fold_coefs_top1_per_fold

# Option 4: Top 3 proteins per fold
#selected_lasso_coefs <- lasso_fold_coefs_top3_per_fold





#-----------------------------------------------------------------------------#




# Outcome variable
y <- as.factor(metadata_df_with_folds$LRTI_adjudication)  

# Function to run Random Forest for one outer CV fold
lassoRF_cv_outer_fold <- function(test_fold) {
  
  # Extract proteins selected by LASSO for this fold
  keep <- selected_lasso_coefs %>%
            filter(fold == test_fold) %>%
            .$gene
  
  #keep <- lasso_fold_coefs_top3$gene #➡️(uncomment to run global top3)

  # Subset protein matrix to selected proteins; rows = samples, columns = selected proteins
  X <- vsd_mat_t[, keep, drop = FALSE]  
  
  # Boolean for training samples
  train <- metadata_df_with_folds$fold != test_fold
  
  # Fit Random Forest (10000 Trees)
  rf <- randomForest(X[train, , drop = FALSE], y[train], ntree = ntrees)
  
  # Predictions on test fold
  preds <- predict(rf, newdata = X[!train, , drop = FALSE], type = "prob")[, "Definite"]
  
  list(test_fold = test_fold, mod = rf, pred = preds)
}

# Run RF across all folds
cv_list <- lapply(1:max(metadata_df_with_folds$fold), lassoRF_cv_outer_fold)

# Ensure correct format
metadata_df_with_folds <- as.data.frame(metadata_df_with_folds)



#-----------------------------------------------------------------------------#




# Collect out-of-fold predictions for all samples
rf_preds <- cv_list %>%
  lapply(function(x) {
    # Get the patient IDs in this test fold
    test_patients <- metadata_df_with_folds$patient_id[metadata_df_with_folds$fold == x$test_fold]
    data.frame(
      patient_id = test_patients,
      pred = x$pred
    )
  }) %>%
  bind_rows() %>%
  dplyr::left_join(
    dplyr::select(metadata_df_with_folds, patient_id, LRTI_adjudication),
    by = "patient_id"
  ) %>%
  dplyr::relocate(LRTI_adjudication, .after = patient_id)


# Save RF predictions
write.csv(rf_preds, file.path(results_dir, "lassoRF_preds.csv"), row.names = FALSE)




# Collect RF votes (training set OOB probabilities)
rf_votes <- cv_list %>%
  lapply(function(x) {
    # Boolean for training samples
    train <- metadata_df_with_folds$fold != x$test_fold
    
    # Votes are in the order of training samples
    votes_df <- as.data.frame(x$mod$votes)
    
    # Add patient_id column from training set
    votes_df <- votes_df %>%
      tibble::rownames_to_column("row_index") %>%  # temporary row index
      dplyr::mutate(patient_id = metadata_df_with_folds$patient_id[train]) %>%
      dplyr::select(patient_id, everything())
    
    # Keep only the Definite column as 'pred'
    votes_df <- votes_df %>%
      dplyr::rename(pred = Definite) %>%
      dplyr::mutate(test_fold = x$test_fold) %>%
      dplyr::select(test_fold, patient_id, pred)
    
    votes_df
  }) %>%
  bind_rows() %>%
  # Join with LRTI adjudication
  dplyr::left_join(
    dplyr::select(metadata_df_with_folds, patient_id, LRTI_adjudication),
    by = "patient_id"
  ) %>%
  dplyr::relocate(LRTI_adjudication, .after = patient_id)

# Save votes
write.csv(rf_votes, file.path(results_dir, "lassoRF_votes.csv"), row.names = FALSE)






#-----------------------------------------------------------------------------#





#print(head(rf_preds))
#print(head(rf_votes))
```



# Generate ROC Graph

```{r}
#| warning: false

library(dplyr)
library(magrittr)
library(pROC)

# Import out-of-fold LASSO / RF predictions
lassoRF_preds <- read.csv(file.path(results_dir, "lassoRF_preds.csv"), stringsAsFactors = FALSE)

# Ensure classes are correct
lassoRF_preds$LRTI_adjudication <- factor(lassoRF_preds$LRTI_adjudication, 
                                          levels = c("No Evidence", "Definite"))

# Function to calculate and plot ROC/AUC for LASSO / RF
output_auc_roc_lassoRF <- function(preds_df, output_suffix) {

  # Compute overall ROC and AUC
  roc_obj <- roc(preds_df$LRTI_adjudication == "Definite", preds_df$pred)
  auc_value <- auc(roc_obj)

  message("Overall AUC for ", output_suffix, ": ", round(auc_value, 3))

  # Plot ROC
  plot(
    roc_obj,
    main = paste("ROC Curve -", output_suffix),
    col = "#1c61b6",
    lwd = 2
  )
  abline(a = 0, b = 1, lty = 2, col = "gray")

  # Save to PDF
  pdf(file.path(results_dir, paste0("ROC_", output_suffix, ".pdf")))
  plot(
    roc_obj,
    main = paste("ROC Curve -", output_suffix),
    col = "#1c61b6",
    lwd = 2
  )
  abline(a = 0, b = 1, lty = 2, col = "gray")
  dev.off()

  # Return AUC
  return(auc_value)
}

auc_lassoRF <- output_auc_roc_lassoRF(lassoRF_preds, "lassoRF")
print(auc_lassoRF)
```






## ROC results

### AUC Values 

lasso_fold_coefs: 0.9301

lasso_fold_coefs_top3: 0.9428

lasso_fold_coefs_top1_per_fold: 0.6705

lasso_fold_coefs_top3_per_fold: 0.8359


